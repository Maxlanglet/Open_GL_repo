<!DOCTYPE html>
<html>
<body style="background-image: url('../extra_rsc/background.jpg');">
<audio src="../extra_rsc/star-wars-cantina.mp3" autoplay> </audio>
<div id="logo" style="background-image: url('../extra_rsc/starvacuum.png');
    padding-left: 0;
    padding-right: 0;
    margin-left: auto;
    margin-right: auto;
    display: block;
    width: 800px;
    height:200px;"></div>
<canvas style="
    padding-left: 0;
    padding-right: 0;
    margin-left: auto;
    margin-right: auto;
    display: block;" id="webgl_canvas" width="1280" height="720"> </canvas>
<div style="
    padding-left: 0;
    padding-right: 0;
    margin-left: auto;
    margin-right: auto;
    display: block;" id="fps"></div>

<script src="../Utilities/gl-matrix-min.js"></script>
<script language="javascript" type="text/javascript" src="../Utilities/camera.js"></script>
<script language="javascript" type="text/javascript" src="../Utilities/shaders.js"></script>
<script language="javascript" type="text/javascript" src="../Utilities/textures.js"></script>
<script language="javascript" type="text/javascript" src="../Utilities/objects_02.js"></script>
<script language="javascript" type="text/javascript" src="../Shaders/shader_Lamb_obj.js"></script>
<script language="javascript" type="text/javascript" src="../Shaders/shader_cubemap.js"></script>
<script language="javascript" type="text/javascript" src="../Utilities/ammo.js"></script>
<script language="javascript" type="text/javascript" src="../Utilities/FullObjectLoader.js"></script>

<script>
    async function main() {
        // Boilerplate code
        const canvas = document.getElementById('webgl_canvas');
        c_width = canvas.width;
        c_height = canvas.height;
        const gl = canvas.getContext('webgl');

        let physicsWorld;
        let lamb_objs=[];
        let rigidBodies = [];
        let rigidBodiesBullet = [];
        let lamb_objs_comps=[];
        let camera;
        let shader_lamb;
        let projection;
        let tmpTrans; //Tmp ammo.js tansform obj
        let deltaTime = 0;
        let timeAction = 0;

        function setupPhysicsWorld(){
            //bt prefix for Bullet
            let collisionConfiguration  = new Ammo.btDefaultCollisionConfiguration(),
            dispatcher              = new Ammo.btCollisionDispatcher(collisionConfiguration),
            overlappingPairCache    = new Ammo.btDbvtBroadphase(), //Alg uses BB to compute collision
            solver                  = new Ammo.btSequentialImpulseConstraintSolver(); //Objets to interact properly (gravity,game logic, etc)

            physicsWorld           = new Ammo.btDiscreteDynamicsWorld(dispatcher, overlappingPairCache, solver, collisionConfiguration);
            physicsWorld.setGravity(new Ammo.btVector3(0, -0.5, 0));
        }

        async function setupGraphics() {
            // Enable tests for better rendering
            gl.enable(gl.DEPTH_TEST);
            //gl.enable(gl.CULL_FACE); // cull hidden faces behind normals!

            //Load the object
            var floor =  new ObjectLoader();
            await floor.constructorAsync(gl,"../Objects/Room-SW/mesh/sol.obj","../Objects/Room-SW/textures/Concreto_color.png");
            floor.createRigidBody(physicsWorld,0,[0,-0.05 ,0],new Ammo.btBoxShape( new Ammo.btVector3( 30, 0, 30 ) ));
            lamb_objs.push(floor);

            for(var i = 1;i<21;i++){
                var seat =  new ObjectLoader();
                await seat.constructorAsync(gl,"../Objects/Room-SW/mesh/seat/seat_"+i.toString()+".obj","../Objects/Room-SW/textures/MaterialSofa_Base_color.png");
                let posSeat = seat.getPos();
                posSeat[1] -= 0;
                seat.createRigidBody(physicsWorld,100,posSeat,new Ammo.btBoxShape( new Ammo.btVector3( 1.5, 1.5, 4 ) ));
                lamb_objs.push(seat);
                rigidBodies.push(seat);
                rigidBodiesBullet.push(seat.getRigidBody());
            }

            var vac = new ObjectLoader();
            await vac.constructorAsync(gl,"../Objects/robot-vacuum-cleaner-rob-vac/vac.obj","../Objects/robot-vacuum-cleaner-rob-vac/textures/internal_ground_ao_texture.jpeg",coef_refl = 1.2);
            vac.translatePos(glMatrix.vec3.fromValues(0,10,0));
            vac.createRigidBody(physicsWorld,30,vac.getPos(),new Ammo.btBoxShape( new Ammo.btVector3(  0.15, 1.0, 0.1 )));
            lamb_objs.push(vac);
            rigidBodies.push(vac);
            rigidBodiesBullet.push(vac.getRigidBody());

            //Different shaders here
            shader_lamb = make_shader(gl, shader_V_lamb, shader_F_lamb);

            //Camera parameters
            let positionInit = glMatrix.vec3.fromValues(0, 0.5, -2.0);
            let up = glMatrix.vec3.fromValues(0.0, 1.0, 0.0);
            yaw = 0.0;
            pitch = 0.0;
            camera = make_camera(canvas, positionInit, up, yaw, pitch, vac);
            projection = camera.get_projection(45.0, c_width / c_height, 0.01, 100.0);
        }

        function renderFrame() {
            gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
            //Draw loop
            deltaTime += 0.005;
            camera.update(deltaTime);
            //Update physics
            updatePhysics(deltaTime);
            //Update camera
            var view = camera.get_view_matrix();

            //Shaders
            shader_lamb.use();
            var unif = shader_lamb.get_uniforms();
            gl.uniformMatrix4fv(unif['view'], false, view);
            gl.uniformMatrix4fv(unif['proj'], false, projection);

            for (var i = 0; i < lamb_objs.length; i++) {
                lamb_objs[i].activateObject(shader_lamb,camera,unif['model']);
            }
            window.requestAnimationFrame(renderFrame);
        }

      function updatePhysics(deltaTime){
        physicsWorld.stepSimulation(deltaTime,10);

        for(let i = 0;i<rigidBodiesBullet.length;i++){
            let objOpenGL = rigidBodies[ i ];
            let objAmmo = rigidBodiesBullet[i];
            let ms = objAmmo.getMotionState();
            if ( ms ) {
                ms.getWorldTransform( tmpTrans );
                console.log();
                let p = tmpTrans.getOrigin();
                let q = tmpTrans.getRotation();
                //objOpenGL.setRotation(glMatrix.quat.fromValues(q.x(),q.y(),q.z(),q.w()));
                var newPos = glMatrix.vec3.fromValues(p.x(),p.y(),p.z());
                objOpenGL.setPosition(newPos);
                camera.updatePosition();
            }
        }
      }

    //Bullet
    Ammo().then(await initBullet );
    async function initBullet(){
        tmpTrans = new Ammo.btTransform();
        setupPhysicsWorld();
        await setupGraphics();
        renderFrame();
    }
  }
  main();
</script>
</body>
</html>