<!DOCTYPE html>
<html>
<body style="background-image: url('../extra_rsc/background.jpg');">
<audio src="../extra_rsc/star-wars-cantina.mp3" autoplay> </audio>
<div id="logo" style="background-image: url('../extra_rsc/starvacuum.png');
    padding-left: 0;
    padding-right: 0;
    margin-left: auto;
    margin-right: auto;
    display: block;
    width: 800px;
    height:200px;"></div>
<canvas style="
    padding-left: 0;
    padding-right: 0;
    margin-left: auto;
    margin-right: auto;
    display: block;" id="webgl_canvas" width="1280" height="720"> </canvas>
<div style="
    padding-left: 0;
    padding-right: 0;
    margin-left: auto;
    margin-right: auto;
    display: block;" id="fps"></div>

<script src="../Utilities/gl-matrix-min.js"></script>
<script language="javascript" type="text/javascript" src="../Utilities/camera.js"></script>
<script language="javascript" type="text/javascript" src="../Utilities/shaders.js"></script>
<script language="javascript" type="text/javascript" src="../Utilities/textures.js"></script>
<script language="javascript" type="text/javascript" src="../Utilities/objects_02.js"></script>
<script language="javascript" type="text/javascript" src="../Shaders/shader_Lamb_obj.js"></script>
<script language="javascript" type="text/javascript" src="../Shaders/shader_cubemap.js"></script>
<script language="javascript" type="text/javascript" src="../Utilities/vacuum.js"></script>

<script>
    async function main() {
        // Boilerplate code
        const canvas = document.getElementById('webgl_canvas');
        c_width = canvas.width;
        c_height = canvas.height;
        const gl = canvas.getContext('webgl');

        // Enable tests for better rendering
        gl.enable(gl.DEPTH_TEST);
        //gl.enable(gl.CULL_FACE); // cull hidden faces behind normals!

        //Load the object
        var lamb_objs = [];
        var lamb_objs_comps = [];
        var wall = await load_obj('../Objects/Room-SW/mesh/interieur_sw.obj');
        var wall_obj = await make_object(gl, wall);
        var wall_shader_comps = await load_shader_lamb(gl,"../Objects/Room-SW/textures/Concreto_color.png");
        lamb_objs.push(wall_obj);
        lamb_objs_comps.push(wall_shader_comps);

        var seats = await load_obj("../Objects/Room-SW/mesh/seat/seat_.obj",20);
        var seats_obj = await make_objects(gl,seats);
        var seats_shader_comps = await load_shader_lamb(gl,"../Objects/Room-SW/textures/MaterialSofa_Base_color.png");
        lamb_objs.push(seats_obj);
        lamb_objs_comps.push(seats_shader_comps);

        var tables = await load_obj("../Objects/Room-SW/mesh/table/table_.obj",10);
        var tables_obj = await make_objects(gl,tables);
        var tables_shader_comps = await load_shader_lamb(gl,"../Objects/Room-SW/textures/MaterialMesa_Base_color.png");
        lamb_objs.push(tables_obj);
        lamb_objs_comps.push(tables_shader_comps);

        var door = await load_obj("../Objects/Room-SW/mesh/porte.obj");
        var door_obj = await make_object(gl,door);
        var door_shader_comps = await load_shader_lamb(gl,"../Objects/Room-SW/textures/Material_Porta_Base_Color.png",coef_refl = 1.2);
        lamb_objs.push(door_obj);
        lamb_objs_comps.push(door_shader_comps);

        var floor = await load_obj("../Objects/Room-SW/mesh/sol.obj");
        var floor_obj = await make_object(gl,floor);
        var floor_shader_comps = await load_shader_lamb(gl,"../Objects/Room-SW/textures/Concreto_color.png");
        lamb_objs.push(floor_obj);
        lamb_objs_comps.push(floor_shader_comps);

        var barrils = await load_obj("../Objects/Room-SW/mesh/barril/barril_.obj",10);
        var barrils_obj = await make_objects(gl,barrils);
        var barrils_shader_comps = await load_shader_lamb(gl,"../Objects/Room-SW/textures/Material_Barril_base_Color.png");
        lamb_objs.push(barrils_obj);
        lamb_objs_comps.push(barrils_shader_comps);

        var bar = await load_obj("../Objects/Room-SW/mesh/bar.obj");
        var bar_obj = await make_object(gl,bar);
        var bar_shader_comps = await load_shader_lamb(gl,"../Objects/Room-SW/textures/Material_Bancada_Base_color.png",coef_refl = 1.2);
        lamb_objs.push(bar_obj);
        lamb_objs_comps.push(bar_shader_comps);

        var bar_up = await load_obj("../Objects/Room-SW/mesh/bar_plafond.obj");
        var bar_up_objs = await make_object(gl,bar_up);
        var bar_up_shader_comps = await load_shader_lamb(gl,"../Objects/Room-SW/textures/Material_Bancada_Teto_Base_color.png",coef_refl = 1.2);
        lamb_objs.push(bar_up_objs);
        lamb_objs_comps.push(bar_up_shader_comps);

        var machine_1 = await load_obj("../Objects/Room-SW/mesh/machine_1.obj");
        var machine_1_obj = await make_object(gl,machine_1);
        var machine_1_shader_comps = await load_shader_lamb(gl,"../Objects/Room-SW/textures/Material_Maquina1_Base_color.png",coef_refl = 1.2);
        lamb_objs.push(machine_1_obj);
        lamb_objs_comps.push(machine_1_shader_comps);

        var machine_2 = await load_obj("../Objects/Room-SW/mesh/machine_2.obj");
        var machine_2_obj = await make_object(gl,machine_2);
        var machine_2_shader_comps = await load_shader_lamb(gl,"../Objects/Room-SW/textures/Material_Maquina2_Base_color.png",coef_refl = 1.2);
        lamb_objs.push(machine_2_obj);
        lamb_objs_comps.push(machine_2_shader_comps);

        var table_int = await load_obj("../Objects/Room-SW/mesh/table_int.obj");
        var table_int_obj = await make_object(gl,table_int);
        var table_int_shader_comps = await load_shader_lamb(gl,"../Objects/Room-SW/textures/Material_Mesa_Meio_Base_color.png",coef_refl = 1.2);
        lamb_objs.push(table_int_obj);
        lamb_objs_comps.push(table_int_shader_comps);

        var vac = await load_obj("../Objects/robot-vacuum-cleaner-rob-vac/vac.obj");
        var vac_obj = await make_object(gl,vac);
        var vac_shader_comps = await load_shader_lamb(gl,"../Objects/robot-vacuum-cleaner-rob-vac/textures/internal_ground_ao_texture.jpeg",coef_refl = 1.2);
        lamb_objs.push(vac_obj);
        lamb_objs_comps.push(vac_shader_comps);

        var boxes = await load_obj("../Objects/Room-SW/mesh/boxes.obj");
        var boxes_obj = await make_object(gl,boxes);
        var boxes_shader_comps = await load_shader_lamb(gl,"../Objects/Room-SW/textures/Material_Caixote_Base_Color.png",coef_refl = 1.2);
        lamb_objs.push(boxes_obj);
        lamb_objs_comps.push(boxes_shader_comps);

        var lights = await load_obj("../Objects/Room-SW/mesh/lights/light_.obj",13);
        var lights_obj = await make_objects(gl,lights);
        var lights_shader_comps = await load_shader_lamb(gl,"../Objects/Room-SW/textures/Yellow.png",coef_emit=100.0);
        lamb_objs.push(lights_obj);
        lamb_objs_comps.push(lights_shader_comps);

        //Define what needed
        let cube = await load_obj("../Objects/Room-SW/mesh/cubemap.obj");
        let cube_obj = await make_object(gl,cube);
        let cube_shader_comps = await load_shader_cubemap(gl,"../Objects/Room-SW/textures/nightpass");
        //let cube_shader_comps = await load_shader_cubemap(gl,"../Objects/yokohama3");
        //Different shaders here
        var shader_lamb = make_shader(gl, shader_V_lamb,shader_F_lamb);
        let shader_cubemap = make_shader(gl,shader_V_cubemap,shader_F_cubemap);

        //place vacuum
        var vac_pos =  glMatrix.vec3.fromValues(0,0.05,0);
        var vacuum = await make_vacuum(vac_obj,vac_pos);
        vacuum.translate_model(vac_pos);
        vacuum.translate_pos(vac_pos);

        //Camera parameters
        let position = glMatrix.vec3.create();
        glMatrix.vec3.add(position,vac_pos,glMatrix.vec3.fromValues(0,0.5,-2.0));

        up = glMatrix.vec3.fromValues(0.0, 1.0, 0.0);
        yaw = 0.0;
        pitch = 0.0;
        var camera = make_camera(canvas, position, up, yaw, pitch,vacuum);
        var projection = camera.get_projection(45.0, c_width / c_height, 0.01, 100.0);

        var deltaTime = 0;

        function animate(time) {
            deltaTime += 0.005;
            camera.update(deltaTime);
            //Draw loop
            //gl.clearColor(0.5, 0.5, 0.5, 1);
            gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

            view = camera.get_view_matrix();

            //Shaders
            shader_lamb.use();
            var unif = shader_lamb.get_uniforms();
            gl.uniformMatrix4fv(unif['view'], false, view);
            gl.uniformMatrix4fv(unif['proj'], false, projection);

            for(var i = 0;i<lamb_objs.length;i++){
                if(lamb_objs[i] instanceof Array){
                    for(var j =0; j<lamb_objs[i].length;j++){
                        (lamb_objs[i][j]).activate(shader_lamb);
                        lamb_objs_comps[i].shader_activate(shader_lamb,lamb_objs[i][j],unif['model'],camera.get_position());
                        lamb_objs[i][j].draw();
                    }
                }
                else{
                    lamb_objs[i].activate(shader_lamb);
                    lamb_objs_comps[i].shader_activate(shader_lamb,lamb_objs[i],unif['model'],camera.get_position());
                    lamb_objs[i].draw();
                }
            }

            gl.depthFunc(gl.LEQUAL);
            shader_cubemap.use();
            unif = shader_cubemap.get_uniforms();
            gl.uniformMatrix4fv(unif['view'], false, view);
            gl.uniformMatrix4fv(unif['proj'], false, projection);

            cube_obj.activate(shader_cubemap);
            cube_shader_comps.shader_activate(shader_cubemap);
            cube_obj.draw();
            //gl.depthFunc(gl.LESS);

            fps(time);
            window.requestAnimationFrame(animate); // While(True) loop!
        }

        var prev = 0;
        const fpsElem = document.querySelector("#fps");
        const logoElem = document.querySelector("#logo");
        function fps(now) {
            now *= 0.001;
            const deltaTime = now - prev;
            prev = now;
            const fps = 1 / deltaTime;
            fpsElem.textContent = 'FPS: ' + fps.toFixed(1);
            return fps;
        }

        animate(0);
    }
    main();
</script>
</body>
</html>


